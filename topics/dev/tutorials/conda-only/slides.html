---
layout: tutorial_slides
topic_name: dev
tutorial_name: conda-only
logo: "GTN"
---

class: enlarge120

![](../../../../shared/images/conda_logo.png)

Package, dependency and environment management

---

class: enlarge120

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Conda Terminology

Conda **recipes** build **packages** that are published to **channels**.

---

class: enlarge120

### .image-25[![](../../../../shared/images/conda_logo.png)] <br /> Conda Key Features for Galaxy

- No compilation at install time - *binaries* with their dependencies, libraries...

- Support for all operating systems Galaxy targets

- Easy to manage *multiple versions* of the same recipe

- HPC-ready: no root privileges needed

- Easy-to-write YAML recipes

- **Community** - not *restricted* to Galaxy

???

- Recipes: independent of the progamming language in which software is written
- Support for multiple versions at the same time is needed for reproducibility

Compared with the Tool Shed dependency management (`tool_dependencies.xml`), BioConda is:

- More popular!
- Easier to develop.
- Easier to install and test.

---

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Conda Distributions

```


```
![](../../images/miniconda_vs_anaconda.png)

---

class: enlarge120

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Best Practice Channels

- Packages through channels within Continuum.

- Conda channels searched by Galaxy for packages
    - iuc
    - bioconda
    - defaults
    - conda-forge

<br/>
<br/>
<br/>

.footnote[If you are interested in Natural Language Processing or Cheminformatics you may be asking if these channels can still work for your tools. Despite the name [Bioconda] (https://bioconda.github.io/) - it is really more about community and a set of best practices than about bioinformatics purity - many diverse packages have been integrated.]

---

class: left

### Conda installation

#### Get the installer

https://conda.io/miniconda.html

#### Miniconda installation on linux

```sh
$ bash Miniconda3-latest-Linux-x86_64.sh
```

#### Anaconda installation on linux

```sh
$ bash Anaconda-latest-Linux-x86_64.sh
```

---

class: left

### Using the `conda search` command

The `conda search` command searches packages available on several channels:

```sh
$ conda search -c bioconda -c conda-forge seqt
```

---

class: enlarge120

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Quickstart
#### Using Conda

- Install a package

```bash
$ conda install pyyaml
```

- Install some packages within an isolated environment

```bash
$ conda create -n yaml pyyaml
$ conda env list
yaml        *  ~/miniconda3/envs/yaml
root             ~/miniconda3
$ source activate yaml
(yaml) $
```

---

### Using Anaconda Search - https://anaconda.org

![](../../images/anaconda_landing.png)


???

---

### Using Anaconda Search - https://anaconda.org

![](../../images/anaconda_result.png)

???

Notice that only one of these results is a best practice channel and so that is the
only one that will be used by Galaxy by default.

---

class: left

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - The Files

A Conda recipe is defined by a directory, the two most important files in this directory are:

- `meta.yaml`: contains all the metadata of the recipe
- `build.sh`: the Unix script that installs the files

---

class: left

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - `meta.yaml`

`meta.yaml` contains basic metadata about the recipe.

```yaml
package:
  name: bwa
  version: "0.7.15"
about:
  home: http://bio-bwa.sourceforge.net
  license: MIT
  summary: The BWA read mapper.
build:
  number: 0
  skip: True # [osx]
source:
  fn: v0.7.15.tar.gz
  url: https://github.com/lh3/bwa/archive/v0.7.15.tar.gz
  md5: 54fdee953c5c256d36885a1c5c6b118c
```

---

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - `requirements`

```yaml
requirements:
  build:
    - gcc   # [not osx]
    - llvm  # [osx]
    - zlib
  run:
    - zlib
    - bowtie2
```
<small>
- `build`: requirements needed during the build step (here compilation)
- `run`: requirements needed at runtime

</small>

---

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - Preprocessing Selectors

- Evaluated as Python expressions - feel free to use `and`, `or`, etc.
- Other common selectors include `py2k`, `py3k`.

```yaml
requirements:
  build:
    - gcc   # [not osx]
    - llvm  # [osx]
    - zlib
```

```yaml
build:
  skip: True  # [not py27]
```

.footer[.center[https://conda.io/docs/building/meta-yaml.html#preprocessing-selectors ]]

---

class: left

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - Tests

<br/>
<br/>

`meta.yaml` should contain simple tests. These are commands executed at the end of `conda build` and expected to return `0` on success.


```yaml
test:
  commands:
    - bowtie2 --version
```

```yaml
test:
  commands:
    - bwa 2>&1 | grep 'index sequences in the'
```

```yaml
test:
  commands:
    - '$R -e "library(''xcms'')"'
```

Please note that the Conda tests run inside the runtime environment and not in the build environment.

.footnote[.center[https://conda.io/docs/building/meta-yaml.html#test-section ]]

---

From Bioconda Guidelines:

> An adequate test must be included in the recipe. An "adequate" test depends on the recipe, but must be able to detect a successful installation. While many packages may ship their own test suite (unit tests or otherwise), including these in the recipe is not recommended since it may timeout the build system on CircleCI. We especially want to avoid including any kind of test data in the repository.

https://bioconda.github.io/guidelines.html

---

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - `build.sh`

```bash
#!/bin/bash
./configure --prefix=$PREFIX
make
make install
```

```bash
#!/bin/bash
mkdir -p $PREFIX/bin
cp *.py $PREFIX/bin
```
<small>
- `$PREFIX` is a variable defined by conda when building the package.
- `$PREFIX` usually contains `bin/`, `lib/`, and `include/` that are filled with the package files.
- `$PREFIX` will be loaded in the user environment at runtime: `PATH`, `LD_LIBRARY_PATH`, `PYTHONPATH`, ...
</small>

---

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - Skeletons

```bash
$ conda skeleton pypi <packagename>
```
```bash
$ conda skeleton cran <packagename>
```
```bash
$ bioconductor_skeleton.py <packagename>
```
```bash
$ conda skeleton cpan <packagename>`
```

These generate pre-filled recipes <small>(not guaranteed to work out of the box)</small> for specific programming environments.

<b>Warning</b> - Conda skeleton creates recipe for windows [win]. You have to remove the bld.bat file and all win references in meta.yaml.

.footnote[[Building conda packages with conda skeleton](https://conda.pydata.org/docs/build_tutorials/pkgs.html)]

---

###.image-25[![](../../../../shared/images/conda_logo.png)] <br/> Writing a Conda Recipe - Local building

#### Installation to build recipes

```sh
conda install conda-build
```

#### Build your recipe

Once the recipe is ready to go, the `conda build` command can be used to build it.

```bash
$ conda build .
```
Be careful, local build uses your system installation.

.footnote[[Documentation about how to write conda recipes from scratch](https://conda.pydata.org/docs/build_tutorials/pkgs2.html) <br/> [Bioconda guidelines](https://bioconda.github.io/guidelines.html)]


---

.image-75[![](../../../../shared/images/bioconda_logo.png)]


- A channel dedicated to bioinformatics (and other informatics) packages
- https://bioconda.github.io
- https://anaconda.org/bioconda
- Open to [contribution](https://bioconda.github.io/contributing.html)
- GitHub repository: https://github.com/bioconda/bioconda-recipes

---

###.image-25[![](../../../../shared/images/bioconda_logo.png)] contributing 1/2

- Fork [Bioconda](https://github.com/bioconda/bioconda-recipes/fork).
- Clone your fork:

  ```bash
  $ git clone https://github.com/<myuser>/bioconda-recipes
  ```

- Create a new branch `package`

  ```bash
  $ git checkout -b package
  ```

- Fill two files `meta.yaml` and `build.sh` in a new recipe directory

- Build your new package and test it using `conda build`

---

###.image-25[![](../../../../shared/images/bioconda_logo.png)] contributing 2/2

- Commit and push to GitHub

  ```bash
  $ git add recipe
  ```

  ```bash
  $ git commit -m 'my recipe description'
  ```

  ```bash
  $ git push origin package
  ```

- Create a [Pull Request](https://github.com/bioconda/bioconda-recipes)

- After the PR is merged, wait for the functional tests to pass on the master branch

- Enjoy your new Conda package at https://anaconda.org/bioconda


See [Contributing with GitHub](../github-contribution/slides.html)

---

class: left

## CircleCI Continuous Building

.image-70[![](../../images/circleci-logo.png)]

- Lint recipes.
- Build and run tests.
- Build and publish Docker container.
- Publish to anaconda.org.

---

## CircleCI Command Line Interface (CLI)

- Installation:

.reduce70[```bash
$ curl -o /usr/local/bin/circleci https://circle-downloads.s3.amazonaws.com/releases/build_agent_wrapper/circleci
```]

.reduce70[```bash
$ chmod +x /usr/local/bin/circleci
```]

- The extended building and testing done by CircleCI can be executed locally using the CircleCI CLI in the root directory of Bioconda

- It should be run from the top-level dir of the repo.

- Build and test recipes:

.reduce70[```bash
$ circleci build
```]

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

![](../../images/exercise.png)

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### The Goal
- Implement and test a local Conda recipe.

- Implement, test and contribute to a Conda recipe .

---

class: left

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### Fleeqtk integration

 - Aim : build a recipe for fleeqtk version 1.3 (local)

 - fleeqtk 1.3 can be downloaded using the URL https://github.com/jmchilton/fleeqtk/archive/v1.3.tar.gz

 - fleeqtk can be built using `make`

 - Use `conda build` to build the recipe

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### Solution

https://github.com/genouest/conda-training/tree/master/recipes/fleeqtk

---

class: left

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### conda-training repository

 - Fork the conda-training repository
  * https://github.com/genouest/conda-training

 - Clone your fork

 - Create a branch for your recipe

 - Create your recipe in recipes/ folder

 - Push your branch and create your pull request

---

class: left

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### bedtools integration

 - Aim :
  * build a recipe for bedtools version 2.27.1 (local)
  * create a pull request on conda-training repository

 - bedtools download page : https://github.com/arq5x/bedtools2/releases/

 - bedtools can be built using make install (be careful to lib / include / etc.)

 - Use circleci to test your recipe

 - Create a pull request and keep a look on circleci tests

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### Solution

https://github.com/genouest/conda-training/tree/master/recipes/bedtools

---

# Advanced Topics in Conda Development

---

## Jinja Templating

```yaml

{% raw %}
{% set name = "seqtk" %}
{% set version = "1.15.1" %}

package:
  name: {{ name }}
  version: {{ version }}

source:
    fn: {{ name }}-{{ version }}.zip
    url: http://coolsoftware.com/{{ name }}/{{ version }}/{{ name }}-{{ version }}.zip

{% endraw %}
```

https://conda.io/docs/building/meta-yaml.html#templating-with-jinja

---

## Bioconda Variables

```yaml
CONDA_PY:
  - 27
  - 35
  - 36
CONDA_HTSLIB: "1.4"
CONDA_BOOST: "1.61"
CONDA_R: "3.3.2"
CONDA_PERL: "5.22.0"
CONDA_NPY: "112"
CONDA_NCURSES: "5.9"
CONDA_GSL: "1.16"
CONDA_GMP: "5.1"
CONDA_HDF5: "1.8.17"
MACOSX_DEPLOYMENT_TARGET: "10.9"
```

.footnote[.center[https://github.com/bioconda/bioconda-recipes/blob/master/scripts/env_matrix.yml ]]

---

class: left

## Pinning Libraries - Use jinja

> If your package links dynamically against a particular library, it is **often necessary to pin the version against which it was compiled, in order to avoid ABI incompatibilities**. Instead of hardcoding a particular version in the recipe, we use jinja templates to achieve this. This **helps ensure that all bioconda packages are binary-compatible with each other**. For example, bioconda provides an environment variable `CONDA_BOOST` that contains the current major version of Boost.

.footnote[.center[https://bioconda.github.io/guidelines.html#c-c ]]

---

class: left

## Stable URLs

```yaml
source:
  fn: v0.7.15.tar.gz
  url: https://github.com/lh3/bwa/archive/v0.7.15.tar.gz
  md5: 54fdee953c5c256d36885a1c5c6b118c
```

> While supported by Conda, `git_url` and `git_rev` are not as stable as a git tarball. Ideally a github repo should have tagged releases that are accessible as tarballs from the “releases” section of the github repo. In addition tarballs can be easily mirrored and Bioconda is saving a copy of every tarball so the recipe can be rebuild at any time.

.footnote[.center[https://bioconda.github.io/guidelines.html#stable-urls ]]

---

class: left

## Python

For PyPI packages

```sh
conda skeleton pypi <package_name>
```

- Builds likely correct `build.sh` and `meta.yaml`.
- The test automatically added is probably sufficient for library, may need to write extra tests for command-line tools.
- Recipes requiring `python` should build on Python 2.7, 3.5, and 3.6 by default, preprocessing selectors can be used with `build: skip` to skip targets.

.footnote[.center[https://bioconda.github.io/guidelines.html#python ]]

---

## Python - pysam's `build.sh`

```sh
#!/bin/bash
# Remove gcc statements that do not work on older compilers for CentOS5
# support
sed -i'' -e 's/"-Wno-error=declaration-after-statement",//g' setup.py
sed -i'' -e 's/"-Wno-error=declaration-after-statement"//g' setup.py
# linking htslib, see:
# https://pysam.readthedocs.org/en/latest/installation.html#external
# https://github.com/pysam-developers/pysam/blob/v0.9.0/setup.py#L79
export CFLAGS="-I$PREFIX/include"
export CPPFLAGS="-I$PREFIX/include"
export LDFLAGS="-L$PREFIX/lib"

export HTSLIB_LIBRARY_DIR=$PREFIX/lib
export HTSLIB_INCLUDE_DIR=$PREFIX/include
$PYTHON setup.py install
```

---

## Python - pysam's `meta.yaml`

.reduce50[```yaml
package:
    name: pysam
    version: 0.11.2.2

source:
    fn: pysam-0.11.2.2.tar.gz
    url: https://pypi.python.org/packages/a4/1b/b6dfd92aea876647d20d9a8bd8618e4f2af6300539426be83c8bb0912d6f/pysam-0.11.2.2.tar.gz
    md5: 56230cd5f55b503845915b76c22d620a
    patches:  # [osx]
      - osx_rpath.patch [osx]

build:
    number: 0
    skip: False

requirements:
    build:
        - gcc  # [linux]
        - llvm # [osx]
        - htslib >=1.4.1,<1.5
        - samtools >=1.4.1,<1.5
        - bcftools >=1.4.1,<1.5
        - cython
        - python
        - setuptools
        - zlib
        - curl

    run:
        - libgcc # [linux]
        - htslib >=1.4.1,<1.5
        - samtools >=1.4.1,<1.5
        - bcftools >=1.4.1,<1.5
        - python
        - zlib
        - curl

test:

    imports:
        - pysam
```]

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

![](../../images/exercise.png)

---

class: left

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### python ngsutils integration

 - Aim :
  * build a recipe for ngsutils
  * create a pull request on conda-training repository

 - Use skeleton

 - Use circleci to test your recipe

 - Create a pull request and keep a look on circleci tests

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### Solution

https://github.com/genouest/conda-training/tree/master/recipes/ngsutils

---

## R

For CRAN packages

```sh
conda skeleton cran <packagename>
```

- Builds likely correct `build.sh` and `meta.yaml`.
- The recipe name will have an `r-` prefix and will be converted to lowercase.
- Typically can be used without modification, though dependencies may also need recipes.

https://bioconda.github.io/guidelines.html#r-cran

---

## R - locfit's `build.sh`

```sh
#!/bin/bash

# R refuses to build packages that mark themselves as Priority: Recommended
mv DESCRIPTION DESCRIPTION.old
grep -v '^Priority: ' DESCRIPTION.old > DESCRIPTION

$R CMD INSTALL --build .
```

---

class: reduce70

## R - locfit's `meta.yaml`

```yaml
package:
  name: r-locfit
  # Note that conda versions cannot contain -, so any -'s in the version have been replaced with _'s.
  version: "1.5_9.1"

source:
  url: https://cran.r-project.org/src/contrib/locfit_1.5-9.1.tar.gz
  md5: 38af7791c9cda78e2804020e65ac7fb4

build:
  number: 0
  rpaths:
    - lib/R/lib/
    - lib/

requirements:
  build:
    - gcc
    - r-base
    - r-lattice
  run:
    - libgcc
    - r-base
    - r-lattice

test:
  commands:
    - $R -e "library('locfit')"

about:
  home: https://cran.rstudio.com/web/packages/locfit/index.html
  license: GPL (>= 2)
  summary: 'Local regression, likelihood and density estimation.'
```

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

![](../../images/exercise.png)

---

class: left

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### qcc integration

 - Aim :
  * build a recipe for qcc library
  * create a pull request on conda-training repository

 - Use skeleton

 - Use circleci to test your recipe

 - Create a pull request and keep a look on circleci tests

---

### <i class="fa fa-pencil" aria-hidden="true"></i> Hands-on

#### Solution

https://github.com/genouest/conda-training/tree/master/recipes/r-qcc

---

## Java

- New recipes should use the `openjdk` package from [conda-forge](https://github.com/conda-forge/openjdk-feedstock).
- Add a wrapper script if the software is typically called via `java -jar`.
- JAR files should go in `$PREFIX/share/$PKG_NAME-$PKG_VERSION-$PKG_BUILDNUM`
- A wrapper script should be placed here as well, and symlinked to $PREFIX/bin.

https://bioconda.github.io/guidelines.html#java

---

## Java - PeptideShaker's `build.sh`

```sh
#!/bin/bash
set -eu -o pipefail

outdir=$PREFIX/share/$PKG_NAME-$PKG_VERSION-$PKG_BUILDNUM
mkdir -p $outdir
mkdir -p $PREFIX/bin
cp -R * $outdir/
cp $RECIPE_DIR/peptide-shaker.py $outdir/peptide-shaker
ls -l $outdir
ln -s $outdir/peptide-shaker $PREFIX/bin
chmod 0755 "${PREFIX}/bin/peptide-shaker"
```

---

class: reduce70

## Java - PeptideShaker's `meta.yaml`

```yaml
...

source:
    fn: {{ name }}-{{ version }}.zip
    url: http://genesis.ugent.be/maven2/eu/isas/peptideshaker/ {{ name }}/{{ version }}/{{ name }}-{{ version }}.zip
    md5: 14a48413e28a25614f5fda2b381d7197

requirements:
  build:
  run:
    - openjdk >=6
    - python

test:
    commands:
      - peptide-shaker eu.isas.peptideshaker.cmd.PeptideShakerCLI
      - peptide-shaker eu.isas.peptideshaker.cmd.PeptideShakerCLI -Xms512m -Xmx1g
```

---

## Perl

For CPAN packages

```sh
conda skeleton cpan <packagename>
```

- Builds likely correct `build.sh` and `meta.yaml`.
- The recipe will have the `perl-` prefix.

.footnote[.center[https://bioconda.github.io/guidelines.html#perl ]]

---

class: reduce70

## Perl - Module-Build

```yaml
package:
  name: perl-module-build
  version: "0.4214"

source:
  fn: Module-Build-0.4214.tar.gz
  url: https://cpan.metacpan.org/authors/id/L/LE/LEONT/Module-Build-0.4214.tar.gz
  md5: 7b7ca5a47bef48c50c8b5906ca3ac7fb

build:
  number: 0

requirements:
  build:
    - gcc
    - perl

  run:
    - libgcc
    - perl

test:
  # Perl 'use' tests
  imports:
    - Module::Build
    - Module::Build::Base
    - Module::Build::Compat
    - Module::Build::Config
    - Module::Build::Cookbook
    - Module::Build::Dumper
    - Module::Build::Notes
    - Module::Build::PPMMaker

about:
  home: https://metacpan.org/pod/Module::Build
  license: perl_5
  summary: 'Build and install Perl modules
```

---

class: left

## Metapackages

> Metapackages tie together other packages. All they do is define dependencies. For example, the hubward-all metapackage specifies the various other conda packages needed to get full hubward installation running just by installing one package.

> Other metapackages might tie together conda packages with a theme. For example, all UCSC utilities related to bigBed files, or a set of packages useful for variant calling.

.footnote[.center[https://bioconda.github.io/guidelines.html#metapackages ]]
